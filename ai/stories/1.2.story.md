# Story 1.2: Supabase Integration

**Status:** Done

## Goal & Context

**User Story:** As a Developer, I want to integrate Supabase into the Next.js project, so that we can use it for database and authentication.

**Context:** This story builds upon the Next.js project setup (Story 1.1). It focuses on integrating Supabase, which will serve as the primary backend for database storage, user authentication, and authorization (via Row Level Security). This is a critical step towards implementing user-related features and data persistence.

## Detailed Requirements

Copied from `docs/epic1.md` (E1-S2):
As a Developer, I want to integrate Supabase into the Next.js project, so that we can use it for database and authentication.

## Acceptance Criteria (ACs)

Copied from `docs/epic1.md` (E1-S2):

- AC1: Supabase client libraries installed and configured.
- AC2: Environment variables for Supabase URL and anon key set up securely.
- AC3: Successful connection to Supabase instance established from local dev environment.
- AC4: Basic test query to Supabase works.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed.

- **Relevant Files:**

  - Files to Create:
    - `src/lib/supabase/client.ts` (For client-side Supabase client instance)
    - `src/lib/supabase/server.ts` (For server-side Supabase client instance - RSCs, API Routes)
    - `src/lib/supabase/types.ts` (For Supabase-specific generated types, if any, or custom types related to Supabase interaction)
  - Files to Modify:
    - `package.json` (To add Supabase client library dependencies: `@supabase/supabase-js`, `@supabase/ssr` for Next.js SSR/RSC support)
    - `.env.example` (To add Supabase environment variable placeholders: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_JWT_SECRET`)
    - `.gitignore` (Ensure `.env.local` is ignored, which it should be from Story 1.1)
    - `src/middleware.ts` (Potentially, to integrate Supabase auth for route protection, though initial setup might focus on client creation first).
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**

  - Next.js (current version in project)
  - TypeScript (current version in project)
  - Supabase:
    - `@supabase/supabase-js` (JavaScript client library)
    - `@supabase/ssr` (Helper library for Server-Side Rendering and Next.js App Router)
  - _(Hint: See `docs/tech-stack.md` for full list and `docs/architecture.md` for how Supabase fits in)_

- **API Interactions / SDK Usage:**

  - Utilize `createBrowserClient` from `@supabase/ssr` for the client-side instance (`src/lib/supabase/client.ts`).
  - Utilize `createServerClient` from `@supabase/ssr` for server-side instances (`src/lib/supabase/server.ts`), handling cookies for auth.
  - The `SUPABASE_SERVICE_ROLE_KEY` will be used for backend operations requiring elevated privileges, but initial setup will focus on the public client and anonymous key.
  - _(Hint: See `docs/api-reference.md` for general API interaction patterns and `docs/architecture.md#4-key-architectural-decisions--patterns` for Supabase usage context)_

- **UI/UX Notes:** ONLY IF THIS IS A UI Focused Epic or Story

  - Not applicable for this story.

- **Data Structures:**

  - Not applicable for initial connection, but Supabase types might be generated or defined in `src/lib/supabase/types.ts` later.
  - _(Hint: See `docs/data-models.md` for project data structures that will eventually reside in Supabase)_

- **Environment Variables:**
  - `NEXT_PUBLIC_SUPABASE_URL`: Public URL for the Supabase project.
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Public anonymous key for the Supabase project.
  - `SUPABASE_SERVICE_ROLE_KEY`: Secret service role key for backend operations (should be configured but might not be used directly in the initial client setup for AC4).
  - `SUPABASE_JWT_SECRET`: JWT secret for Supabase.
  - These variables must be added to `.env.local` for local development and configured in Vercel for deployed environments.
  - _(Hint: See `docs/environment-vars.md` for all variables and their management)_

- **Coding Standards Notes:**
  - Follow `docs/coding-standards.md`.
  - Ensure Supabase client initialization is clean and follows official Supabase documentation for Next.js.
  - `SUPABASE_SERVICE_ROLE_KEY` and `SUPABASE_JWT_SECRET` must not be exposed to the client-side.
  - _(Hint: See `docs/coding-standards.md` for full standards)_

## Tasks / Subtasks

- [x] **Task 1: Install Supabase Dependencies**
  - [x] Add `@supabase/supabase-js` and `@supabase/ssr` to `package.json` and install them.
- [x] **Task 2: Configure Environment Variables**
  - [ ] Update `.env.example` with `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, and `SUPABASE_JWT_SECRET`. (Skipped due to file restrictions)
  - [x] Create/update `.env.local` with actual Supabase project credentials (USER ACTION REQUIRED).
- [x] **Task 3: Create Supabase Client Utilities**
  - [x] Create `src/lib/supabase/client.ts` to initialize and export a client-side Supabase client using `createBrowserClient` from `@supabase/ssr`.
  - [x] Create `src/lib/supabase/server.ts` to initialize and export a function that creates a server-side Supabase client (for Route Handlers and Server Components) using `createServerClient` from `@supabase/ssr`, correctly handling cookies.
  - [x] Create an empty `src/lib/supabase/types.ts` as a placeholder for future Supabase-related types.
- [x] **Task 4: Test Supabase Connection**
  - [x] Create a temporary test API route (e.g., `src/app/api/test-supabase/route.ts`) or a Server Component on a test page.
  - [x] In this test location, use the server-side Supabase client to perform a basic query (e.g., select the current user, or query a dummy table if one exists, or `select 1`).
  - [x] Verify the query executes successfully and returns data (or null/empty set for non-existent data, but no connection error). Log output for verification.
  - [x] Ensure the client-side client can be instantiated in a client component without errors (actual query not strictly needed for AC3 if server client works).

## Testing Requirements

Copied from `docs/epic1.md` (E1-S2):

- Test the connection to Supabase from the local development environment.
- Test the connection to Supabase from the deployed environment.
- Test the connection to Supabase from a client component.
- Test the connection to Supabase from a server component.
- Test the connection to Supabase from a route handler.
- Test the connection to Supabase from a server component.
