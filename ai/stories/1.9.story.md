# Story 1.9: User Profile Management

**Status:** Review

**DoD Reference:** All aspects of this story must adhere to the standards outlined in `docs/definition-of-done.md`.

## Goal & Context

**User Story:** As a logged-in User, I want to be able to view and update my basic profile information, so that my account details are accurate.

**Context:** This story builds upon the implementation of the core authentication system (Stories 1.1-1.3), user registration flows (Stories 1.4-1.6), login functionality (Story 1.7), and email service configuration (Story 1.8). With users able to register, verify their email, and log in, we now need to provide them with the ability to view and update their basic profile information. This will allow users to keep their account details accurate and up-to-date, which is essential for maintaining the integrity of user data in the system and providing a complete user account management experience.

## Detailed Requirements

As a logged-in User, I want to be able to view and update my basic profile information, so that my account details are accurate.

## Acceptance Criteria (ACs)

- AC1: Profile page accessible to logged-in users.
- AC2: Displays current Full Name and Email (email possibly read-only or with re-verification).
- AC3: Allows user to update Full Name.
- AC4: Allows user to change their password (current password + new password + confirm new password).
- AC5: Changes are saved to Supabase.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed. **All implementation details must align with `docs/definition-of-done.md` criteria.**

- **Relevant Files:**
  - Files to Create:
    - `src/app/profile/page.tsx` (Profile management page)
    - `src/components/features/profile/ProfileForm.tsx` (Profile update form component)
    - `src/components/features/profile/PasswordUpdateForm.tsx` (Password change form component)
  - Files to Modify:
    - `src/lib/supabase/auth.ts` (To add profile update and password change functionality)
    - `src/app/layout.tsx` or relevant navigation component (To add link to profile page)
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**
  - Next.js (App Router)
  - React
  - TypeScript
  - Supabase Auth and Database
  - React Hook Form with Zod
  - shadcn/ui components
  - _(Hint: See `docs/tech-stack.md` for full list)_

- **API Interactions / SDK Usage:**
  - Use Supabase Auth API for password updates: `supabase.auth.updateUser()`
  - Use Supabase Database API for profile updates: `supabase.from('profiles').update()`
  - Implement proper session management to ensure user is authenticated
  - _(Hint: See `docs/api-reference.md` for details on external APIs and SDKs)_

- **Data Structures:**
  - **ProfileFormData**:
    - `fullName`: string
  
  - **PasswordUpdateFormData**:
    - `currentPassword`: string
    - `newPassword`: string
    - `confirmNewPassword`: string
  
  - **User/Profile**:
    - Uses Supabase `auth.users` table for authentication data
    - Uses `profiles` table for additional profile information
  
  - _(Hint: See `docs/data-models.md` for complete data structure details)_

- **Environment Variables:**
  - `NEXT_PUBLIC_SUPABASE_URL`: Supabase project URL
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Supabase anonymous key
  - _(Hint: See `docs/environment-vars.md` for all variables)_

- **Coding Standards Notes:**
  - Use React Hook Form with Zod for form validation
  - Implement proper error handling and user feedback
  - Use server actions for form submissions
  - Follow established component structure and naming conventions
  - Use shadcn/ui components for consistent styling
  - Implement responsive design for mobile compatibility
  - _(Hint: See `docs/coding-standards.md` for full standards)_

## Tasks / Subtasks

- [x] **Task 1: Create Profile Page**
  - [x] Create `src/app/profile/page.tsx` with appropriate structure
  - [x] Implement authentication check to prevent unauthenticated access
  - [x] Add page metadata and layout with proper heading
  - [x] Structure page to contain both profile info and password update sections

- [x] **Task 2: Implement Profile Update Form**
  - [x] Create `src/components/features/profile/ProfileForm.tsx` component
  - [x] Fetch and display current profile information from Supabase
  - [x] Implement form for updating full name with validation
  - [x] Create submission handler to update profile in Supabase
  - [x] Add appropriate loading states and success/error feedback

- [x] **Task 3: Implement Password Update Form**
  - [x] Create `src/components/features/profile/PasswordUpdateForm.tsx` component
  - [x] Implement form with fields for current password, new password, and confirm new password
  - [x] Add password validation requirements (minimum length, complexity)
  - [x] Create submission handler to update password via Supabase Auth
  - [x] Add appropriate loading states and success/error feedback

- [x] **Task 4: Update Supabase Auth Functionality**
  - [x] Modify `src/lib/supabase/auth.ts` to add profile update function
  - [x] Add password update function with proper validation and error handling
  - [x] Implement transaction pattern if needed for related updates

- [x] **Task 5: Add Navigation to Profile Page**
  - [x] Update navigation component to include a link to the profile page
  - [x] Ensure the link is only visible to authenticated users

- [x] **Task 6: Testing**
  - [x] Create test files for ProfileForm component
  - [x] Create test files for PasswordUpdateForm component
  - [x] Test profile update functionality with valid and invalid inputs
  - [x] Test password update functionality with valid and invalid inputs
  - [x] Test authentication protection for the profile page

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. **All testing must satisfy the criteria in `docs/definition-of-done.md` (section 3.3) and align with `docs/testing-strategy.md`.**

- **Unit Tests:**
  - Test the profile form component validation logic
  - Test the password update form validation logic
  - Test the profile update submission handler
  - Test the password update submission handler
  - Test authentication check for the profile page

- **Integration Tests:**
  - Test end-to-end profile update flow using a Supabase test environment
  - Test end-to-end password update flow using a Supabase test environment
  - Verify that changes are correctly saved to the database
  - Test scenarios with both valid and invalid inputs

- **Manual Verification:**
  - Verify that the profile page is accessible only to authenticated users
  - Complete the profile update process and verify that changes persist after logout/login
  - Test password update functionality with valid credentials
  - Test password update with invalid current password
  - Test password update with mismatched new password and confirmation
  - Verify appropriate error messages for all validation failures
  - Check that the UI is responsive and maintains consistent styling

## DoD Checklist (Story Specific Points)

- [x] **Requirements & ACs:** All criteria in DoD section 3.1 met.
- [x] **Design & Implementation:** All criteria in DoD section 3.2 met.
- [x] **Testing & Verification:** All criteria in DoD section 3.3 met.
- [x] **Documentation & Handover:** All criteria in DoD section 3.4 met.
- [x] **Story Management:** All criteria in DoD section 3.5 met.
- _(Note: This is a reminder; detailed checks are in `docs/definition-of-done.md`)_

## Story Draft Validation

| Category                             | Status | Issues                         |
| ------------------------------------ | ------ | ------------------------------ |
| 1. Goal & Context Clarity            | PASS   | None                           |
| 2. Requirements & Acceptance Criteria| PASS   | None                           |
| 3. Technical Implementation Guidance | PASS   | None                           |
| 4. Reference Effectiveness           | PASS   | None                           |
| 5. Self-Containment Assessment       | PASS   | None                           |
| 6. Testing Guidance                  | PASS   | None                           |
| 7. DoD Compliance                    | PASS   | None                           |

**Final Assessment:** READY - The story provides sufficient context for implementation and aligns with DoD. The story builds logically upon previous authentication and registration stories (1.1-1.8) and provides clear implementation guidance for profile management functionality that aligns with the established project structure and coding standards. 

## Completion Notes

All tasks have been successfully implemented. The profile management feature now allows users to:

1. View their profile information (full name and email)
2. Update their full name
3. Change their password with proper validation
4. Receive appropriate feedback during these operations

Key implementation points:
- Authentication protection is in place to ensure only logged-in users can access the profile page
- Form validation using Zod ensures data integrity
- Error handling provides clear feedback to users
- Password updates require the current password for security
- Profile updates are stored in the Supabase profiles table
- Navigation to the profile page is available from the dashboard
- Comprehensive tests are in place to verify functionality

All acceptance criteria have been met and the implementation follows the project's coding standards and architecture patterns. 