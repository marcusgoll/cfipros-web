# Story 1.16: Set up Stripe products/prices and basic subscription management

**Status:** Done

**DoD Reference:** All aspects of this story must adhere to the standards outlined in `docs/definition-of-done.md`.

## Goal & Context

**User Story:** As a Developer, I want to set up Stripe products/prices and a basic mechanism to flag/manage subscription status in the DB, so core subscribed features can be developed.

**Context:** This story builds the foundation for subscription management that will be fully implemented in Epic 4. By setting up Stripe products/prices and creating the subscription status tracking mechanism in the database, we enable early development of subscription-based features for CFIs and Flight Schools. This is a critical infrastructure story that must be completed before implementing any subscription-dependent features.

## Detailed Requirements

- Stripe products and prices for CFI/School MVP subscriptions defined in Stripe dashboard.
- `subscriptions` table created in Supabase (linking to users/organizations) with fields like `stripe_subscription_id`, `status` (e.g., 'active', 'inactive', 'past_due'), `current_period_end`.
- Initial RLS for `subscriptions` table.
- A simple mechanism to manually update or have a very basic webhook update this status for early development of subscribed features (full webhook handling in Epic 4).

## Acceptance Criteria (ACs)

- AC1: Stripe products and prices for CFI/School MVP subscriptions are defined in the Stripe dashboard.
- AC2: A `subscriptions` table is created in Supabase with appropriate fields including `id`, `created_at`, `updated_at`, `deleted_at`, `user_id`, `school_id`, `stripe_customer_id`, `stripe_subscription_id`, `status`, `current_period_start`, `current_period_end`, and `cancel_at_period_end`.
- AC3: Row Level Security (RLS) policies for the `subscriptions` table are implemented to ensure only authorized users can view and modify subscription data.
- AC4: A basic Stripe webhook endpoint is implemented to listen for subscription-related events and update the subscription status in the database.
- AC5: A simple utility function is created to check if a user or school has an active subscription.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed. **All implementation details must align with `docs/definition-of-done.md` criteria.**

- **Relevant Files:**

  - Files to Create:
    - `src/lib/stripe/client.ts` (Stripe client setup)
    - `src/lib/stripe/types.ts` (Stripe-related TypeScript interfaces)
    - `supabase/migrations/[timestamp]_create_subscriptions_table.sql` (Migration file for creating subscriptions table)
    - `src/app/api/subscriptions/stripe-webhook/route.ts` (Basic Stripe webhook endpoint)
    - `src/services/subscriptionService.ts` (Subscription management service)
  - Files to Modify:
    - `src/lib/types/subscription.ts` (Add/update subscription-related types if needed)
    - `scripts/migrations/[relevant-script].ts` (If using a script to apply migrations)
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**

  - TypeScript
  - Node.js (Latest LTS)
  - Next.js 14.x (API Routes)
  - Supabase (PostgreSQL)
  - Stripe API/SDK (Latest stable)
  - _(Hint: See `docs/tech-stack.md` for full list)_

- **API Interactions / SDK Usage:**

  - **Stripe SDK:**
    - Initialize Stripe client with `STRIPE_SECRET_KEY`
    - Set up webhook handling with `stripe.webhooks.constructEvent` for signature verification
    - Handle events: `customer.subscription.created`, `customer.subscription.updated`, `customer.subscription.deleted`
    - _(Hint: See `docs/api-reference.md` for details on Stripe webhook integration)_
  - **Supabase:**
    - Use server-side Supabase client for database operations
    - Set up RLS policies for the subscriptions table
    - _(Hint: See `docs/api-reference.md` for Supabase integration patterns)_

- **Data Structures:**

  - Use the `Subscription` interface from `src/lib/types/subscription.ts` with fields matching the DB schema
  - Ensure proper typing for Stripe webhook event handlers
  - _(Hint: See `docs/data-models.md` for the `Subscription` interface definition)_

- **Environment Variables:**

  - `STRIPE_SECRET_KEY`: Stripe secret API key for backend operations
  - `STRIPE_WEBHOOK_SECRET`: Secret for verifying Stripe webhook signatures
  - `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`: Publishable key for frontend Stripe integration (needed later)
  - _(Hint: See `docs/environment-vars.md` for details)_

- **Coding Standards Notes:**
  - Use async/await for all Stripe API calls
  - Implement robust error handling for Stripe API errors and webhook processing failures
  - Ensure proper logging of errors (without exposing sensitive information)
  - Follow TypeScript best practices for type safety
  - **Ensure all code adheres to `docs/coding-standards.md` and DoD section 3.2.**
  - For the webhook endpoint:
    - Verify webhook signature using Stripe's SDK
    - Use proper HTTP response codes (200 on success, appropriate error codes on failure)
    - Return minimal response data (success or error message)

## Tasks / Subtasks

- [x] Set up Stripe products and prices in the Stripe dashboard
  - [x] Create product for CFI subscription
  - [x] Create product for Flight School subscription
  - [x] Define pricing plans (monthly, annual options)
  - [x] Document product and price IDs for later use
- [x] Create Stripe client setup in `src/lib/stripe/client.ts`
  - [x] Initialize Stripe client with API key
  - [x] Export methods for subscription-related operations
- [x] Create Stripe-related types in `src/lib/stripe/types.ts`
  - [x] Define types for Stripe webhook events
  - [x] Define types for subscription status
- [x] Create Subscription model and database
  - [x] Create migration file for `subscriptions` table
  - [x] Implement the migration in Supabase
  - [x] Create appropriate Row Level Security (RLS) policies
- [x] Implement Stripe webhook handler
  - [x] Create basic webhook endpoint at `src/app/api/subscriptions/stripe-webhook/route.ts`
  - [x] Add webhook signature verification
  - [x] Implement event handlers for subscription-related events
  - [x] Update subscription status in Supabase based on events
- [x] Create subscription utility functions
  - [x] Function to check if a user has an active subscription
  - [x] Function to check if a school has an active subscription
- [x] Documentation and testing
  - [x] Document Stripe product and price IDs
  - [x] Test webhook functionality using Stripe CLI or test events
  - [x] Update README with Stripe integration details if needed

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. **All testing must satisfy the criteria in `docs/definition-of-done.md` (section 3.3) and align with `docs/testing-strategy.md`.**

- **Unit Tests:**

  - Write unit tests for `subscriptionService.ts` functions with mocked Stripe client and Supabase client
  - Test webhook handler with mocked Stripe event objects
  - Test subscription status checking utility functions
  - **Ensure adequate code coverage and that all new/modified logic is unit tested.**

- **Integration Tests:**

  - Test the complete webhook flow using Stripe's test webhook events
  - Test database updates triggered by webhook events
  - **These tests should validate that the subscription status is properly updated in the database when Stripe events are received.**

- **Manual/CLI Verification:**

  - Verify Stripe products and prices are correctly set up in the Stripe dashboard
  - Use Stripe CLI to send test webhook events to the local webhook endpoint
  - Manually verify that subscription records in Supabase are updated correctly
  - **Document clear steps for manual verification of webhook processing and database updates.**

- **Automated Verification:**
  - Create a basic test script that:
    - Creates a test subscription in Stripe
    - Triggers relevant webhook events
    - Verifies the subscription status in the database
  - **This script should be runnable in a development environment to verify end-to-end functionality.**

## DoD Checklist (Story Specific Points)

- [x] **Requirements & ACs:** All criteria in DoD section 3.1 met.
  - All Stripe products and prices correctly defined
  - Subscriptions table created with appropriate schema
  - RLS policies implemented correctly
  - Webhook endpoint functional
  - Utility functions for checking subscription status working
- [x] **Design & Implementation:** All criteria in DoD section 3.2 met.
  - Code follows architectural patterns and coding standards
  - Error handling is robust
  - Type safety is ensured
  - Security best practices followed (especially for handling Stripe webhooks)
- [x] **Testing & Verification:** All criteria in DoD section 3.3 met.
  - Unit tests cover core functionality
  - Integration tests verify webhook handling
  - Manual verification steps documented and executed
- [x] **Documentation & Handover:** All criteria in DoD section 3.4 met.
  - Code is well commented
  - Stripe product/price IDs documented
  - Any special considerations for the webhook endpoint documented
- [x] **Story Management:** All criteria in DoD section 3.5 met.
  - Story status updated
  - Any deviations from original plan documented
- _(Note: This is a reminder; detailed checks are in `docs/definition-of-done.md`)_

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Claude 3.7 Sonnet`
- **Completion Notes:** Implemented Stripe integration for subscription management following the requirements. Created necessary database models, client functions, and webhook handlers. Added comprehensive test coverage for subscription service and webhook handlers. Key implementation details include:
  1. Created Stripe client setup with functions for managing subscriptions
  2. Defined TypeScript types for Stripe interactions and subscription management
  3. Created migration for subscriptions table with RLS policies
  4. Implemented webhook handler for processing Stripe events
  5. Developed utility functions to check subscription status
  6. Added test coverage for all components
  7. Documented product and price IDs in the migration file
- **Change Log:**
  - Initial Draft
  - Implementation Complete - Ready for Review
