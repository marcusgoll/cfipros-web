# Story 1.6: School Admin Account Signup

**Status:** In-Progress

## Goal & Context

**User Story:** As a School Admin, I want to be able to sign up for a new Flight School account, so that I can manage my school on the platform.

**Context:** This story builds upon the implementation of the basic user authentication system (Stories 1.1-1.3) and the Student/CFI account registration flows (Stories 1.4-1.5). With the foundational user authentication and database schema in place, we now need to implement the sign-up functionality for Flight School Administrators. School Admins are users who will have access to manage their flight school on the platform, including managing CFIs and students associated with their school, after subscribing. This story focuses on the School Admin account registration process, which follows a similar flow to student and CFI registration but includes additional school-related information and guidance toward the subscription flow.

## Detailed Requirements

Copied from `docs/epic1.md` (E1-S6):
As a School Admin, I want to be able to sign up for a new Flight School account, so that I can manage my school on the platform.

## Acceptance Criteria (ACs)

Copied from `docs/epic1.md` (E1-S6):

- AC1: Signup form available with fields for Full Name, School Name, Email, Password, Confirm Password.
- AC2: Successful submission creates a new user record with 'SchoolAdmin' role and potentially a new school record.
- AC3: Email verification sent.
- AC4: Post-signup, user is guided towards subscription flow (Epic 4).
- AC5: Appropriate error handling.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed.

- **Relevant Files:**

  - Files to Create:
    - `src/app/school-sign-up/page.tsx` (School-specific signup page)
    - `src/components/features/auth/SchoolSignUpForm.tsx` (School signup form component)
  - Files to Modify:
    - `src/lib/supabase/auth.ts` (To add School-specific signup functionality)
    - `src/services/email.ts` (To adapt email verification for School role)
    - `src/app/sign-up/page.tsx` (To add link to School signup option)
    - `src/app/cfi-sign-up/page.tsx` (To add link to School signup option)
    - `src/app/profile-setup/page.tsx` (To handle School Admin role assignment during profile setup)
    - `src/app/dashboard/cfi/subscribe-guidance/page.tsx` (To adapt for School subscriptions or create a new school-specific guidance page)
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**

  - Next.js
  - React
  - TypeScript
  - Supabase Auth
  - Resend (for email)
  - Zod (for form validation)
  - React Hook Form
  - shadcn/ui components
  - _(Hint: See `docs/tech-stack.md` for full list and version information)_

- **API Interactions / SDK Usage:**

  - Use Supabase Auth API for user registration: `supabase.auth.signUp()`
  - Use Supabase Database API to create school record
  - Use Resend API to send verification emails
  - Implement verification link handling with Supabase URL parameters
  - _(Hint: See `docs/api-reference.md` for details on external APIs and SDKs)_

- **Data Structures:**

  - **SchoolSignUpFormData**:
    - `fullName`: string
    - `schoolName`: string
    - `email`: string
    - `password`: string
    - `confirmPassword`: string
    - `part61Or141Type`: 'PART_61' | 'PART_141'
  - **User Record**:
    - Uses Supabase `auth.users` table for authentication
    - Creates corresponding record in `profiles` table with role set to 'SCHOOL_ADMIN'
  - **School Record**:
    - Creates a new record in the `schools` table with:
      - `name`: string (from the form)
      - `admin_user_id`: UUID (foreign key to the user's profile ID)
      - `part_61_or_141_type`: 'PART_61' | 'PART_141' (from the form)
  - _(Hint: See `docs/data-models.md` for complete data structure details)_

- **Environment Variables:**

  - `NEXT_PUBLIC_SUPABASE_URL`: Supabase project URL
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Supabase anonymous key
  - `RESEND_API_KEY`: API key for Resend email service
  - _(Hint: See `docs/environment-vars.md` for all variables)_

- **Coding Standards Notes:**
  - Use React Hook Form with Zod for form validation
  - Implement proper error handling and user feedback
  - Follow the established component structure from the Student and CFI signup flows
  - Use shadcn/ui components for consistent styling
  - Implement responsive design for mobile compatibility
  - _(Hint: See `docs/coding-standards.md` for full standards)_

## Tasks / Subtasks

- [x] **Task 1: Create School Sign-Up Form Component**

  - [x] Create `src/components/features/auth/SchoolSignUpForm.tsx` component
  - [x] Implement form fields: Full Name, School Name, Email, Password, Confirm Password, Part 61/141 type
  - [x] Integrate the OAuthProviders component (from Story 1.5)
  - [x] Set up form validation using Zod
  - [x] Add submission handler that creates both user and school records
  - [x] Display appropriate loading states and error messages
  - [x] Add links to Student and CFI signup pages

- [x] **Task 2: Create School Sign-Up Page**

  - [x] Create `src/app/school-sign-up/page.tsx` to render the School signup form
  - [x] Add page metadata and appropriate heading
  - [x] Ensure page is styled consistently with the student and CFI signup pages
  - [x] Add clear UI indication that this is for Flight School Administrators

- [x] **Task 3: Update Supabase Auth Functionality**

  - [x] Modify `src/lib/supabase/auth.ts` to add `signUpWithEmailSchool` function
  - [x] Implement transaction that creates both user and school records
  - [x] Handle OAuth signup for School Admins
  - [x] Ensure proper error handling and rollback if any step fails

- [x] **Task 4: Update Profile Setup Flow**

  - [x] Modify `src/app/profile-setup/page.tsx` to handle School Admin role
  - [x] Update UI to reflect School Admin specific profile setup
  - [x] Ensure school information is correctly associated with the admin user

- [x] **Task 5: Implement Post-Profile Setup Flow**

  - [x] Create or adapt subscription guidance page for School Admins
  - [x] Add clear call-to-action to continue to subscription
  - [x] Include placeholder or link for the upcoming subscription page (from Epic 4)

- [x] **Task 6: Update Other Sign-Up Pages**

  - [x] Modify `src/app/sign-up/page.tsx` to include a link for School Admins
  - [x] Modify `src/app/cfi-sign-up/page.tsx` to include a link for School Admins

- [x] **Task 7: Testing**
  - [x] Create test files for SchoolSignUpForm component
  - [x] Update profile-setup tests to include School Admin flow
  - [x] Update subscription-guidance tests to include School Admin flow
  - [x] Create E2E tests for the complete School Admin signup flow

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:**

  - Test the School signup form component validation logic
  - Test the OAuth providers for School signup
  - Test the profile setup functionality for School Admin role assignment
  - Test the school record creation in the database

- **Integration Tests:**

  - Test the end-to-end signup flow using a Supabase test environment
  - Test the creation of both user and school records
  - Verify the correct role assignment in the profiles table
  - Verify email verification functionality
  - Test the flow to subscription guidance

- **Manual Verification:**
  - Complete the email/password signup process for a School Admin
  - Test OAuth signup for School Admins
  - Verify the verification email is received and works correctly
  - Complete the profile setup process and verify the School Admin role is assigned
  - Verify the school record is created correctly with the proper relationship to the admin
  - Verify the UI flow from signup to profile setup to subscription guidance
  - Test form validation and error handling
