# Story 1.12: Implement "Forgot Password" Functionality

**Status:** Done

**DoD Reference:** All aspects of this story must adhere to the standards outlined in `docs/definition-of-done.md`.

## Goal & Context

**User Story:** As a User, I want a "Forgot Password" functionality, so I can reset my password if I forget it.

**Context:** This story builds upon the existing authentication system. Previously, we implemented basic signup and login functionality (Stories 1.4 and 1.7) and email integration with Supabase Auth and Resend (Story 1.8). The login form already includes a "Forgot password?" link that points to a non-existent page `/forgot-password`. Now we need to implement the complete password reset flow, providing users with a way to recover their accounts when they forget their passwords.

## Detailed Requirements

As a User, I want a "Forgot Password" functionality with the following features:

1. When I click the existing "Forgot password?" link on the login page, I should be directed to a password reset request page.
2. The password reset request page should have a form where I can enter my email address.
3. If the email exists in our system, a password reset link should be sent via Supabase Auth.
4. Clicking the link in the email should take me to a page where I can enter and confirm a new password.
5. After successful password reset, I should be redirected to the login page.
6. I should receive appropriate error handling and feedback messages throughout the process.

## Acceptance Criteria (ACs)

- AC1: Password reset request page is accessible from the "Forgot password?" link on the login page.
- AC2: User can enter their email address on the password reset request page.
- AC3: If email exists, a password reset link is sent via Supabase Auth.
- AC4: Clicking the link takes user to a page to enter and confirm a new password.
- AC5: New password updates the user's Supabase record.
- AC6: User receives appropriate feedback at each step of the process.
- AC7: User is redirected to the login page after successful password reset.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed. **All implementation details must align with `docs/definition-of-done.md` criteria.**

- **Relevant Files:**
  - Files to Create:
    - `src/app/auth/forgot-password/page.tsx` (Password reset request form)
    - `src/app/auth/reset-password/page.tsx` (New password entry form)
    - `src/components/features/auth/ForgotPasswordForm.tsx` (Password reset request form component)
    - `src/components/features/auth/ResetPasswordForm.tsx` (New password entry form component)
    - `src/services/authService.ts` (If it doesn't exist, create it to house password reset methods)
  - Files to Modify:
    - `src/components/features/auth/LoginForm.tsx` (Update the existing "Forgot password?" link path if needed)
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**
  - Next.js App Router
  - React (functional components)
  - TypeScript
  - Supabase Auth for password reset
  - shadcn/ui components (Button, Input, Form, etc.)
  - React Hook Form for form validation
  - _(Hint: See `docs/tech-stack.md` for full list)_

- **API Interactions:**
  - Supabase Auth:
    - Use `auth.resetPasswordForEmail(email)` to send reset link
    - Use `auth.updatePassword(newPassword)` to update password
  - Handling of reset token in URL parameters
  - _(Hint: See `docs/api-reference.md` for details on Supabase Auth integration)_

- **Data Structures:**
  - Password reset request form data: `{ email: string }`
  - Password reset form data: `{ password: string, confirmPassword: string }`
  - _(Hint: See `docs/data-models.md` for key project data structures)_

- **Environment Variables:**
  - Uses existing Supabase environment variables
  - _(Hint: See `docs/environment-vars.md` for all variables)_

- **Coding Standards Notes:**
  - Implement proper form validation (email format, password strength, matching passwords)
  - Use React Hook Form for form state management
  - Provide clear error messages and loading states
  - Use proper TypeScript typing for all components and functions
  - Track analytics events for password reset flow
  - _(Hint: See `docs/coding-standards.md` for full standards)_

## Tasks / Subtasks

- [x] **Task 1: Implement Password Reset Request Page**
  - [x] Create `src/app/auth/forgot-password/page.tsx`
  - [x] Create `src/components/features/auth/ForgotPasswordForm.tsx` with email input
  - [x] Implement form validation for email
  - [x] Connect form to Supabase Auth (`auth.resetPasswordForEmail`)
  - [x] Add appropriate loading states and error handling
  - [x] Implement success feedback after form submission

- [x] **Task 2: Implement Password Reset Page**
  - [x] Create `src/app/auth/reset-password/page.tsx`
  - [x] Create `src/components/features/auth/ResetPasswordForm.tsx` with password inputs
  - [x] Implement form validation for password fields (strength, matching)
  - [x] Extract reset token from URL
  - [x] Connect form to Supabase Auth (`auth.updatePassword`)
  - [x] Add appropriate loading states and error handling
  - [x] Redirect to login page after successful password reset

- [x] **Task 3: Create Auth Service**
  - [x] Create `src/services/authService.ts` if it doesn't exist
  - [x] Implement password reset methods (requestPasswordReset, resetPassword)
  - [x] Ensure error handling is consistent with other auth methods
  - [x] Add TypeScript type definitions for all functions and return values

- [x] **Task 4: Update Existing Login Form**
  - [x] Verify the existing "Forgot password?" link points to the correct path
  - [x] Update the link path if needed (currently points to `/forgot-password`, may need to be `/auth/forgot-password`)

- [x] **Task 5: Analytics Integration**
  - [x] Add analytics tracking for password reset flow using the `trackEvent` function
  - [x] Track events like "password_reset_requested" and "password_reset_completed"
  - [x] Add appropriate properties to events (excluding PII)

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. **All testing must satisfy the criteria in `docs/definition-of-done.md` (section 3.3) and align with `docs/testing-strategy.md`.**

- **Unit Tests:**
  - Test ForgotPasswordForm component:
    - Renders correctly
    - Validates email input
    - Shows loading state during submission
    - Shows error message on invalid email
    - Shows success message on valid submission
  - Test ResetPasswordForm component:
    - Renders correctly
    - Validates password inputs (strength, matching)
    - Shows loading state during submission
    - Shows error message on invalid password
    - Shows success message on valid submission
  - Test auth service password reset methods

- **Integration Tests:**
  - Test complete password reset flow:
    - Requesting password reset
    - Accessing reset page with token
    - Setting new password
    - Redirecting to login page
  - Test error handling for:
    - Invalid email
    - Invalid token
    - Password validation failures

- **Manual Verification:**
  - Verify reset email is actually sent
  - Verify reset link in email works correctly
  - Verify logging in with new password works
  - Verify old password no longer works

## DoD Checklist (Story Specific Points)

- [x] **Requirements & ACs:** All criteria in DoD section 3.1 met.
- [x] **Design & Implementation:** All criteria in DoD section 3.2 met.
- [x] **Testing & Verification:** All criteria in DoD section 3.3 met.
- [x] **Documentation & Handover:** All criteria in DoD section 3.4 met.
- [x] **Story Management:** All criteria in DoD section 3.5 met.
- _(Note: This is a reminder; detailed checks are in `docs/definition-of-done.md`)_

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Claude 3.7 Sonnet`
- **Completion Notes:** The "Forgot Password" functionality has been successfully implemented following all requirements and acceptance criteria. The implementation includes:
  
  1. A password reset request page accessible from the login form that allows users to enter their email address and request a password reset
  2. A password reset page that allows users to enter and confirm a new password after clicking the reset link in the email
  3. Backend service functions for requesting password resets and updating passwords via Supabase Auth
  4. Form validation with appropriate error messages
  5. Analytics tracking for key password reset events
  6. Comprehensive unit tests for all components and services
  
  All components follow the existing project structure and coding standards, with proper TypeScript typing, loading states, and error handling. The implementation uses React Hook Form for form validation and shadcn/ui components for the UI. Security best practices are followed, such as not disclosing whether an email exists in the system during the password reset request process.

- **Change Log:** {Track changes _within this specific story file_ if iterations occur}
  - Initial Draft
  - Updated to reflect existing "Forgot password?" link in LoginForm
  - Completed draft ready for review 
  - Updated to mark all tasks as completed and change status to Review 