# Story 1.5: CFI Account Signup

**Status:** Done

**Note:** All tests have been successfully completed:
- ✅ OAuthProviders Component Tests: All tests pass
- ✅ CFISignUpForm Component Tests: All tests pass
- ✅ Profile Setup Integration Tests: All tests pass
- ✅ Subscription Guidance Integration Tests: All tests pass 
- ✅ E2E Tests: All tests pass across all browsers (Chromium, Firefox, WebKit, Mobile Chrome, Mobile Safari)

The implementation of all components, functionality, and tests is now complete.

## Goal & Context

**User Story:** As a CFI, I want to be able to sign up for a new CFI account, so that I can access CFI-specific features and subscribe.

**Context:** This story builds upon the implementation of the Student account registration (Story 1.4). With the basic user authentication and database schema in place, we now need to implement the sign-up functionality for Certified Flight Instructors (CFIs). CFIs are a critical user type who will have access to advanced features after subscribing. This story focuses on the CFI account registration process, which follows the same flow as student registration but with the CFI role designation and guidance toward the subscription flow.

## Detailed Requirements

Copied from `docs/epic1.md` (E1-S5):
As a CFI, I want to be able to sign up for a new CFI account, so that I can access CFI-specific features and subscribe.

## Acceptance Criteria (ACs)

Copied from `docs/epic1.md` (E1-S5) with modifications:

- AC1: Signup form available with fields for Email, Password, Confirm Password (fullName will be collected after verification).
- AC2: OAuth options available for signup with Google and Microsoft accounts.
- AC3: Successful submission creates a new user record in Supabase.
- AC4: Email verification sent to the user.
- AC5: After verification and login, user is prompted to set up their profile with fullName and role set to 'CFI'.
- AC6: Post-profile setup, user is guided towards subscription flow (Epic 4).
- AC7: Appropriate error handling.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed.

- **Relevant Files:**

  - Files to Create:
    - `src/app/cfi-sign-up/page.tsx` (CFI-specific signup page)
    - `src/components/features/auth/CFISignUpForm.tsx` (CFI signup form component)
    - `src/components/features/auth/OAuthProviders.tsx` (Component for OAuth buttons)
  - Files to Modify:
    - `src/lib/supabase/auth.ts` (To add CFI-specific signup functionality and OAuth)
    - `src/services/email.ts` (To adapt email verification for CFI role)
    - `src/app/sign-up/page.tsx` (To add link to CFI signup option)
    - `src/app/profile-setup/page.tsx` (To handle CFI role assignment during profile setup)
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**

  - Next.js
  - React
  - TypeScript
  - Supabase Auth with OAuth providers
  - Resend (for email)
  - Zod (for form validation)
  - React Hook Form
  - shadcn/ui components
  - _(Hint: See `docs/tech-stack.md` for full list and version information)_

- **API Interactions / SDK Usage:**

  - Use Supabase Auth API for user registration: `supabase.auth.signUp()`
  - Use Supabase OAuth providers: `supabase.auth.signInWithOAuth()`
  - Use Resend API to send verification emails
  - Implement verification link handling with Supabase URL parameters
  - _(Hint: See `docs/api-reference.md` for details on external APIs and SDKs)_

- **Data Structures:**

  - **SignUpFormData**:
    - `email`: string
    - `password`: string
    - `confirmPassword`: string
  
  - **ProfileSetupData**:
    - `fullName`: string
  
  - **User Record**:
    - Uses Supabase `auth.users` table for authentication
    - Creates corresponding record in `profiles` table with role set to 'CFI' during profile setup
  
  - _(Hint: See `docs/data-models.md` for complete data structure details)_

- **Environment Variables:**
  - `NEXT_PUBLIC_SUPABASE_URL`: Supabase project URL
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Supabase anonymous key
  - `RESEND_API_KEY`: API key for Resend email service
  - _(Hint: See `docs/environment-vars.md` for all variables)_

- **Coding Standards Notes:**
  - Use React Hook Form with Zod for form validation
  - Implement proper error handling and user feedback
  - Follow the established component structure from the Student signup flow
  - Use shadcn/ui components for consistent styling
  - Implement responsive design for mobile compatibility
  - _(Hint: See `docs/coding-standards.md` for full standards)_

## Tasks / Subtasks

- [x] **Task 1: Create OAuth Providers Component**
  - [x] Create `src/components/features/auth/OAuthProviders.tsx` with buttons for Google and Microsoft
  - [x] Implement OAuth sign-in functionality using Supabase Auth
  - [x] Add appropriate styling and icons for OAuth buttons
  - [x] Handle OAuth errors and display appropriate messages

- [x] **Task 2: Create CFI Sign-Up Form Component**
  - [x] Create `src/components/features/auth/CFISignUpForm.tsx` component based on the existing SignUpForm
  - [x] Implement form fields: Email, Password, Confirm Password (remove fullName field)
  - [x] Integrate the OAuth Providers component
  - [x] Set up form validation using Zod with the same validation rules as the Student form
  - [x] Add submission handler that calls Supabase auth
  - [x] Display appropriate loading states and error messages
  - [x] Add link to regular student signup for users who mistakenly arrived at CFI signup

- [x] **Task 3: Create CFI Sign-Up Page**
  - [x] Create `src/app/cfi-sign-up/page.tsx` to render the CFI signup form
  - [x] Add page metadata and appropriate heading
  - [x] Ensure page is styled consistently with the student signup page
  - [x] Add clear UI indication that this is for Flight Instructors

- [x] **Task 4: Update Profile Setup Flow**
  - [x] Modify `src/app/profile-setup/page.tsx` to handle CFI role assignment
  - [x] Add logic to check if the user is coming from CFI signup and set role accordingly
  - [x] Update UI to reflect CFI-specific profile setup

- [x] **Task 5: Implement Post-Profile Setup Flow**
  - [x] After profile setup, redirect CFIs to a subscription guidance page
  - [x] Create a success page or message that guides CFIs towards the subscription flow
  - [x] Add clear call-to-action to continue to subscription
  - [x] Include placeholder or link for the upcoming subscription page (from Epic 4)

- [x] **Task 6: Update Student Sign-Up Page**
  - [x] Modify `src/app/sign-up/page.tsx` to include a link for CFIs to redirect to CFI signup
  - [x] Add OAuth providers to student signup as well for consistency

- [x] **Task 7: Testing**
  - [x] Create test files for OAuthProviders, CFISignUpForm, profile-setup and subscribe-guidance components
  - [x] Set up testing infrastructure with Jest and Playwright
  - [x] Fix and complete the unit tests for OAuthProviders component
  - [x] Fix and complete the unit tests for CFISignUpForm component
  - [x] Fix and complete the integration tests for profile-setup
  - [x] Fix and complete the integration tests for subscription-guidance
  - [x] Create basic E2E tests with Playwright
  - [x] Verify all component tests pass successfully

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:**
  - Test the CFI signup form component validation logic
  - Test the OAuth providers component
  - Test the profile setup functionality for CFI role assignment

- **Integration Tests:**
  - Test the end-to-end signup flow using a Supabase test environment
  - Test OAuth authentication flow with Google and Microsoft
  - Verify the correct role assignment in the profiles table
  - Verify email verification functionality

- **Manual Verification:**
  - Complete the email/password signup process
  - Test OAuth signup with Google and Microsoft accounts
  - Verify the verification email is received and works correctly
  - Complete the profile setup process and verify the CFI role is assigned
  - Verify the UI flow from signup to profile setup to subscription guidance
  - Test form validation and error handling
  - Verify that OAuth users are properly redirected to profile setup if needed 