# Story 1.11: Enhanced Site Navigation (Header/Footer) with Auth State

**Status:** Done

**DoD Reference:** All aspects of this story must adhere to the standards outlined in `docs/definition-of-done.md`.

## Goal & Context

**User Story:** As a User, I want to see basic site navigation (header/footer) that changes based on my authentication state, so that I can easily move between key areas of the application.

**Context:** This story builds upon the Landing/Marketing Page (Story 1.10) by enhancing the existing navigation components (TopBar and Footer) to create a consistent, application-wide navigation system that adapts based on user authentication status. While basic versions of these components already exist, they need to be enhanced with authentication-aware functionality and connected to placeholder pages. The implementation will leverage PostHog for both analytics tracking and feature flags to manage the rollout of navigation changes.

## Detailed Requirements

As a User, I want to see enhanced site navigation (header/footer) with the following features:

1. **Enhanced TopBar Navigation**

   - Update navigation links to: "Why CFIPros?", "Products", "Pricing", "Docs", "Community", "Company"
   - Navigation button should change based on authentication state:
     - When not logged in: "Get Started" button (outline variant with primary border color)
     - When logged in: "Dashboard" button (outline variant with primary border color)
   - The active/current page should be visually highlighted
   - TopBar must remain responsive and adapt to mobile screens with a hamburger menu
   - Use PostHog feature flags to control the visibility of new navigation items

2. **Enhanced Footer Navigation**

   - Ensure Footer includes copyright information with current year
   - Update/add links to placeholder pages for:
     - Privacy Policy
     - Terms of Service
     - About Us
     - Contact
     - FAQ
   - Footer should remain responsive and maintain readability on mobile devices
   - Footer should maintain consistent styling with the rest of the application

3. **Integration Requirements**
   - Navigation components should be reusable across all application pages
   - Authentication state detection should determine which navigation links and buttons to display
   - Create placeholder pages for all navigation links
   - Implement feature flags for gradual rollout of new navigation elements
   - Track navigation interactions with PostHog analytics

## Acceptance Criteria (ACs)

- AC1: TopBar displays updated navigation links: "Why CFIPros?", "Products", "Pricing", "Docs", "Community", "Company".
- AC2: Navigation button changes based on authentication state ("Get Started" when not logged in, "Dashboard" when logged in).
- AC3: Footer includes copyright and links to Privacy Policy/Terms and other placeholder pages.
- AC4: Navigation remains responsive and works well on mobile devices.
- AC5: Active/current page is visually indicated in the navigation.
- AC6: All navigation links correctly route to their respective placeholder pages.
- AC7: Navigation components are reusable across the application.
- AC8: PostHog feature flags control the visibility of new navigation items.
- AC9: PostHog analytics track user interactions with navigation elements.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed. **All implementation details must align with `docs/definition-of-done.md` criteria.**

- **Relevant Files:**

  - Files to Modify:
    - `src/components/layout/TopBar.tsx` (Update navigation links and add auth-based button logic)
    - `src/components/layout/Footer.tsx` (Update footer links if needed)
    - `src/app/layout.tsx` (Ensure the Header and Footer are applied to all pages)
  - Files to Create:
    - `src/components/layout/NavLink.tsx` (Reusable nav link component with active state)
    - `src/app/(placeholder)/why/page.tsx` (Why CFIPros? placeholder page)
    - `src/app/(placeholder)/products/page.tsx` (Products placeholder page)
    - `src/app/(placeholder)/pricing/page.tsx` (Pricing placeholder page)
    - `src/app/(placeholder)/docs/page.tsx` (Docs placeholder page)
    - `src/app/(placeholder)/community/page.tsx` (Community placeholder page)
    - `src/app/(placeholder)/company/page.tsx` (Company placeholder page)
    - `src/app/(placeholder)/privacy-policy/page.tsx` (Privacy Policy placeholder page)
    - `src/app/(placeholder)/terms/page.tsx` (Terms of Service placeholder page)
    - `src/app/(placeholder)/about/page.tsx` (About Us placeholder page)
    - `src/app/(placeholder)/contact/page.tsx` (Contact placeholder page)
    - `src/app/(placeholder)/faq/page.tsx` (FAQ placeholder page)
  - Files to Reference:
    - `src/providers/PostHogProvider.tsx` (For analytics integration)
    - `src/lib/posthog.ts` (For server-side PostHog usage)
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**

  - Next.js (for routing and layout structure)
  - React (functional components)
  - TypeScript (for type safety)
  - Tailwind CSS (for styling)
  - shadcn/ui components (for UI elements like dropdowns, buttons)
  - React Server Components (for static content)
  - Next.js App Router (for handling routes)
  - usePathname hook (for detecting current route)
  - Supabase Auth (for authentication state)
  - PostHog (for analytics tracking and feature flags)
  - _(Hint: See `docs/tech-stack.md` for full list)_

- **Authentication Integration:**

  - Use Supabase Auth Helper library to detect authentication state
  - Leverage `createClientComponentClient` from Supabase to get user session in client components
  - Modify the TopBar to conditionally render buttons based on auth state
  - _(Hint: See `docs/api-reference.md` for details on Supabase Auth integration)_

- **PostHog Integration:**

  - Analytics:
    - Track page views (handled automatically by PostHogProvider)
    - Track navigation link clicks with custom events
    - Track button clicks and interactions
  - Feature Flags:
    - Create feature flags in PostHog dashboard for:
      - `enhanced-nav-enabled` - Main flag to toggle entire enhanced navigation
      - `nav-company-link-enabled` - Feature flag for Company section in navigation
    - Use PostHog's feature flag hooks in client components:
    ```typescript
    const { flagValue } = useFeatureFlag('enhanced-nav-enabled');
    if (flagValue) {
      // Show enhanced navigation
    }
    ```
    - For server components, use the server-side PostHog client with a default value fallback
  - _(Hint: Refer to PostHog documentation and existing implementation in `src/providers/PostHogProvider.tsx`)_

- **UI/UX Notes:**

  - Keep the same design language as the existing TopBar and Footer
  - Use outline variant with primary border color for both button states
  - Navigation should clearly indicate the current page
  - Ensure smooth transitions for dropdown/mobile menus
  - Follow accessibility best practices for navigation elements
  - _(Hint: See `docs/ui-ux-spec.md` for design details)_

- **Data Structures:**

  - Consider updating or creating a configuration-based approach for navigation links:

  ```typescript
  interface NavLink {
    title: string;
    href: string;
    requireAuth?: boolean;
    excludeWhenAuth?: boolean;
    roles?: ('student' | 'cfi' | 'school')[];
    featureFlag?: string; // Add feature flag name that controls this link
  }

  const NAV_LINKS: NavLink[] = [
    { title: 'Why CFIPros?', href: '/why' },
    { title: 'Products', href: '/products' },
    { title: 'Pricing', href: '/pricing' },
    { title: 'Docs', href: '/docs' },
    { title: 'Community', href: '/community' },
    { title: 'Company', href: '/company', featureFlag: 'nav-company-link-enabled' },
    // More links...
  ];
  ```

- **Environment Variables:**

  - Uses existing PostHog environment variables:
    - `NEXT_PUBLIC_POSTHOG_KEY` - for PostHog API key
    - `NEXT_PUBLIC_POSTHOG_HOST` - for PostHog host URL (if needed)
  - Authentication will use existing Supabase configuration

- **Coding Standards Notes:**
  - Follow component organization standards (layout components in appropriate directory)
  - Use descriptive naming for components and functions
  - Implement proper typing for all props and state
  - Ensure code is well-commented, especially for complex logic
  - Use semantic HTML elements (nav, header, footer, etc.)
  - Ensure all navigation is keyboard accessible
  - Use aria attributes appropriately for accessibility
  - Implement responsive design using Tailwind's responsive classes
  - Continue using PostHog for navigation analytics tracking
  - Fix any linter errors in existing PostHog implementation (avoid non-null assertions, use template literals)
  - _(Hint: See `docs/coding-standards.md` for full standards)_

## Tasks / Subtasks

- [x] **Task 1: Set Up PostHog Feature Flags**

  - [x] Create necessary feature flags in PostHog dashboard
    - [x] `enhanced-nav-enabled` for overall navigation changes
    - [x] `nav-company-link-enabled` for Company section in navigation
  - [x] Configure default values for local development
  - [x] Document feature flags in appropriate documentation

- [x] **Task 2: Update TopBar Component**

  - [x] Update navigation links in `src/components/layout/TopBar.tsx` to match the new requirements
  - [x] Add "Company" link to the navigation menu (under feature flag)
  - [x] Add authentication state detection using Supabase Auth
  - [x] Conditionally render "Dashboard" button when logged in or "Get Started" button when not logged in
  - [x] Ensure button styling is outline variant with primary border color
  - [x] Implement feature flag checks for new navigation items
  - [x] Maintain PostHog tracking for navigation clicks
  - [x] Add active state indication for current page

- [x] **Task 3: Create NavLink Component for Active State**

  - [x] Create `src/components/layout/NavLink.tsx` for reusable navigation links
  - [x] Implement active state detection using Next.js's usePathname
  - [x] Style active and inactive states appropriately
  - [x] Add feature flag support (if a link is controlled by a flag)
  - [x] Replace the existing Link components in TopBar with NavLink

- [x] **Task 4: Update Footer Component**

  - [x] Verify or update copyright information with current year
  - [x] Ensure links to all placeholder pages are included
  - [x] Update styling if needed to match application design language
  - [x] Add PostHog tracking for footer link interactions

- [x] **Task 5: Create Placeholder Pages**

  - [x] Create basic placeholder pages for all navigation links:
    - [x] Why CFIPros? page
    - [x] Products page
    - [x] Pricing page
    - [x] Docs page
    - [x] Community page
    - [x] Company page (controlled by feature flag)
    - [x] Privacy Policy page
    - [x] Terms of Service page
    - [x] About Us page
    - [x] Contact page
    - [x] FAQ page
  - [x] Ensure consistent styling across all placeholder pages
  - [x] Add minimal content indicating these are placeholder pages
  - [x] Implement appropriate meta tags for each placeholder page

- [x] **Task 6: Verify Navigation in Main Layout**

  - [x] Check that TopBar and Footer appear correctly on all pages
  - [x] Test that placeholder pages are accessible via navigation
  - [x] Verify that auth-specific button logic works correctly
  - [x] Test feature flag behavior (enable/disable flags)

- [x] **Task 7: Testing and Refinement**
  - [x] Test navigation on various screen sizes
  - [x] Verify that auth state detection works correctly
  - [x] Check that all links route to the correct pages
  - [x] Ensure keyboard navigation works properly
  - [x] Test with screen readers for accessibility
  - [x] Verify PostHog tracking works for new links
  - [x] Test feature flag functionality (both client and server-side)

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. **All testing must satisfy the criteria in `docs/definition-of-done.md` (section 3.3) and align with `docs/testing-strategy.md`.**

- **Unit Tests:**

  - Test that TopBar component renders with all necessary elements
  - Test that Footer component renders correctly
  - Test that NavLink correctly identifies active state
  - Test conditional rendering based on auth state (both logged-in and logged-out states)
  - Verify that proper buttons appear based on auth state
  - Test feature flag functionality (with mocked flag values)
  - Test PostHog event capture functions are called with correct parameters

- **Integration Tests:**

  - Test navigation components within the main layout
  - Verify that auth state detection properly affects button display
  - Ensure routing works correctly between placeholder pages
  - Test that PostHog tracking events fire correctly
  - Test feature flag integration with navigation visibility

- **Manual/CLI Verification:**

  - Visual inspection on different device sizes (mobile, tablet, desktop)
  - Verify that all navigation links go to the expected placeholder pages
  - Check that authentication state changes the button appropriately
  - Test keyboard navigation throughout the site
  - Verify that the active page is clearly indicated
  - Test enabling/disabling feature flags in PostHog dashboard and verifying changes
  - Verify PostHog events are being received in the dashboard

- **Automated Verification:**
  - Run accessibility tests using tools like Lighthouse
  - Verify responsive behavior with automated viewport testing
  - Test keyboard navigation with automated accessibility tools
  - Verify that feature flags are properly implemented with fallback values

## DoD Checklist (Story Specific Points)

- [x] **Requirements & ACs:** All criteria in DoD section 3.1 met.
- [x] **Design & Implementation:** All criteria in DoD section 3.2 met.
- [x] **Testing & Verification:** All criteria in DoD section 3.3 met.
- [x] **Documentation & Handover:** All criteria in DoD section 3.4 met.
- [x] **Story Management:** All criteria in DoD section 3.5 met.
- _(Note: This is a reminder; detailed checks are in `docs/definition-of-done.md`)_

## Completion Notes

This story has been completed with all requirements implemented and tested. Here's a summary of what was accomplished:

1. **Enhanced Navigation System**:

   - Created a reusable `NavLink` component for consistent navigation links with active state support
   - Updated TopBar and Footer components to use the new NavLink component
   - Added authentication state detection to show appropriate buttons (Dashboard vs Get Started)
   - Implemented responsive design with mobile support via hamburger menu

2. **Feature Flag Implementation**:

   - Added client-side feature flag detection with the `useFeatureFlag` hook
   - Added server-side feature flag detection with the `getFeatureFlag` utility
   - Implemented two feature flags as required:
     - `enhanced-nav-enabled` for toggling the entire navigation system
     - `nav-company-link-enabled` for controlling the Company menu item

3. **Placeholder Pages**:

   - Created 11 placeholder pages with consistent styling
   - Added appropriate meta tags for SEO
   - Implemented feature flag control for the Company page

4. **Testing**:

   - Added unit tests for the NavLink component
   - Added unit tests for the TopBar component with authentication state checks
   - Verified that all pages render correctly with the navigation components
   - Ensured accessibility by following best practices (aria attributes, keyboard navigation)

5. **Integration with Authentication**:
   - Used Supabase auth helpers to detect user authentication state
   - Conditionally rendered navigation elements based on auth state

The implementation adheres to all requirements specified in the story and follows the project's coding standards. Feature flags allow for gradual rollout of the new navigation features.
