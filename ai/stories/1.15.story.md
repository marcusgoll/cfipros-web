# Story 1.15: Set up Initial Testing Frameworks and Mocking Infrastructure

**Status:** Done

**DoD Reference:** All aspects of this story must adhere to the standards outlined in `docs/definition-of-done.md`.

## Goal & Context

**User Story:** As a Developer, I want to set up the initial testing frameworks (Jest, React Testing Library) and core mocking infrastructure for external services, so that unit and integration testing can begin.

**Context:** This story builds upon the initial project setup (Story E1-S1) and is critical for establishing a robust testing culture from the outset, as per `docs/testing-strategy.md`. It enables developers to write unit and component tests for new features and ensures external dependencies can be mocked effectively.

## Detailed Requirements

As a Developer, I want to set up the initial testing frameworks (Jest, React Testing Library) and core mocking infrastructure for external services, so that unit and integration testing can begin.

## Acceptance Criteria (ACs)

- AC1: Jest and React Testing Library are installed and configured as per `docs/testing-strategy.md`.
- AC2: Basic test script added to `package.json`.
- AC3: Initial mock setup for key external services (Supabase client, Gemini API, Stripe API, Resend API) is created (e.g., in `__mocks__` or test setup files) to allow for isolated unit/integration testing as outlined in `docs/testing-strategy.md`.
- AC4: Example unit test and component test are created and pass.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed. **All implementation details must align with `docs/definition-of-done.md` criteria.**

- **Relevant Files:**
  - Files to Create:
    - `jest.config.cjs` (or `jest.config.ts`)
    - `src/__mocks__/` (directory for manual mocks)
    - `src/__mocks__/supabase-client.ts` (example manual mock for Supabase client, assuming client is at `src/lib/supabase/client.ts`)
    - `src/__mocks__/gemini-api.ts` (example manual mock for Gemini API client, assuming client is at `src/lib/gemini/index.ts` or similar)
    - `src/__mocks__/stripe-api.ts` (example manual mock for Stripe API client, assuming client is at `src/lib/stripe/index.ts` or similar)
    - `src/__mocks__/resend-api.ts` (example manual mock for Resend API client, assuming client is at `src/lib/resend/index.ts` or similar)
    - `tests/unit/example.test.ts` (example unit test)
    - `src/components/ui/__tests__/Button.test.tsx` (example component test for an existing simple shadcn/ui component like `Button` - create a basic button if none exists or pick another simple one)
    - `jest.setup.js` (or `jest.setup.ts` for global test setup)
  - Files to Modify:
    - `package.json` (add devDependencies for Jest, React Testing Library, types, ts-jest, etc.; add test scripts)
    - `tsconfig.json` (ensure `jest` types are included, potentially `esModuleInterop: true`, `jsx: 'react-jsx'`)
    - `tsconfig.jest.json` (optional, if a separate tsconfig for jest is used)
    - `.gitignore` (add `coverage/` directory)
  - _(Hint: See `docs/project-structure.md` for overall layout. `docs/testing-strategy.md` suggests test files alongside source or in `__tests__` subdirectories. `docs/project-structure.md` also shows a top-level `tests/unit/` directory. Component tests (e.g., for Button) should be in `src/components/ui/__tests__/`. Other unit tests for utility functions can go into `tests/unit/`.)_

- **Key Technologies:**
  - Jest
  - React Testing Library (`@testing-library/react`, `@testing-library/jest-dom`)
  - `@testing-library/user-event`
  - TypeScript
  - `ts-jest`
  - `@types/jest`
  - Node.js
  - `identity-obj-proxy` (for mocking CSS modules/styles in Jest)
  - _(Hint: See `docs/tech-stack.md`. `docs/testing-strategy.md` confirms Jest and RTL.)_

- **API Interactions / SDK Usage:**
  - This story focuses on mocking these. The mocks should provide basic mock implementations for:
    - Supabase client (e.g., `createClient` from `src/lib/supabase/client.ts`)
    - Gemini API client (from `src/lib/gemini/...`)
    - Stripe API client (from `src/lib/stripe/...`)
    - Resend API client (from `src/lib/resend/...`)
  - Mocks should allow spying on calls and controlling return values using `jest.fn()`.
  - _(Hint: Refer to `docs/api-reference.md` for general API features. Check actual client paths from `src/lib/` as implemented in stories like E1-S2, E1-S8.)_

- **UI/UX Notes:** 
  - Not applicable for this story, beyond testing a simple UI component.

- **Data Structures:**
  - Not directly applicable for this story, other than what mocked functions might return.
  - _(Hint: See `docs/data-models.md` if example tests need to mock specific data shapes.)_

- **Environment Variables:**
  - Test-specific environment variables might be needed, configure in `jest.setup.js` or via Jest config (`globals` section).
  - _(Hint: See `docs/environment-vars.md`.)_

- **Coding Standards Notes:**
  - Test file naming: `*.test.ts` or `*.test.tsx`.
  - Organize mocks in `src/__mocks__/`. The filename of the mock must match the module it's mocking (e.g. if Supabase client is `src/lib/supabase/client.ts`, the mock is `src/__mocks__/supabase/client.ts` - Jest will auto-mock if the mock directory is adjacent to node_modules, otherwise manual `jest.mock(\'path/to/module\')` is needed in tests). For simplicity with `src/__mocks__`, ensure Jest's `roots` config or manual mocks in tests are used.
  - Test descriptions should be clear (e.g., using `describe`, `it`, `test`).
  - All code and configuration must adhere to `docs/coding-standards.md`.
  - Ensure `setupFilesAfterEnv` in Jest config points to `jest.setup.js` for `@testing-library/jest-dom`.

## Tasks / Subtasks

- [x] **Task 1: Install Testing Dependencies**
  - [x] Add `jest`, `@types/jest`, `ts-jest`, `@testing-library/react`, `@testing-library/jest-dom`, `@testing-library/user-event`, `identity-obj-proxy` to `devDependencies` in `package.json`.
  - [x] Run package manager install command (e.g., `npm install`).
- [x] **Task 2: Configure Jest**
  - [x] Create `jest.config.cjs`.
  - [x] Configure it with `preset: 'ts-jest'`, `testEnvironment: 'jsdom'`.
  - [x] Configure `moduleNameMapper` for CSS/static assets (e.g., `{ "\\\\.css$": "identity-obj-proxy" }`).
  - [x] Set `setupFilesAfterEnv: ['<rootDir>/jest.setup.js']`. (Using existing `<rootDir>/src/test-setup.ts` which serves the same purpose)
  - [x] Create `jest.setup.js` (or `jest.setup.ts`) in the project root and import `'@testing-library/jest-dom/extend-expect'`. (Existing `src/test-setup.ts` handles this)
  - [x] Update `tsconfig.json` (or create/use `tsconfig.jest.json` referenced by Jest config) to include `"jest"` in `types`, set `"esModuleInterop": true`, `"jsx": "react-jsx"`.
- [x] **Task 3: Add Test Scripts to `package.json`**
  - [x] Add: `"test": "jest"` (Existing script `"test": "jest --config jest.config.cjs"` retained)
  - [x] Add: `"test:watch": "jest --watch"` (Existing script `"test:watch": "jest --config jest.config.cjs --watch"` retained)
  - [x] Add: `"test:cov": "jest --coverage"` (Existing script `"test:coverage": "jest --config jest.config.cjs --coverage"` retained)
  - [x] Add `coverage/` to `.gitignore`. (Already present)
- [ ] **Task 4: Implement Mocking Infrastructure**
  - [ ] Create `src/__mocks__/` directory.
  - [ ] Create basic manual mocks for:
    - `src/lib/supabase/client.ts` (if this is the correct path to the Supabase client module). Create `src/__mocks__/lib/supabase/client.ts`.
    - Mocks for Gemini, Stripe, Resend clients following the same pattern (e.g., if Gemini client is `src/lib/gemini/index.ts`, mock is `src/__mocks__/lib/gemini/index.ts`).
  - Mocks should export `jest.fn()` for key functions of these clients.
- [ ] **Task 5: Create Example Tests**
  - [ ] Create `tests/unit/example.test.ts`:
    ```typescript
    // tests/unit/example.test.ts
    function add(a: number, b: number): number {
      return a + b;
    }

    describe('add function', () => {
      it('should return the sum of two numbers', () => {
        expect(add(1, 2)).toBe(3);
      });
    });
    ```
  - [ ] Create `src/components/ui/__tests__/Button.test.tsx` (assuming `Button` component exists at `src/components/ui/button.tsx` from shadcn):
    ```tsx
    // src/components/ui/__tests__/Button.test.tsx
    import React from 'react';
    import { render, screen } from '@testing-library/react';
    import { Button } from '../button'; // Adjust import path as necessary

    describe('Button Component', () => {
      it('should render a button with text', () => {
        render(<Button>Click Me</Button>);
        expect(screen.getByRole('button', { name: /Click Me/i })).toBeInTheDocument();
      });
    });
    ```
  - [ ] Ensure these tests pass when running the test script.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. **All testing must satisfy the criteria in `docs/definition-of-done.md` (section 3.3) and align with `docs/testing-strategy.md`.**

- **Unit Tests:**
  - The example unit test (`tests/unit/example.test.ts`) must pass.
  - The example component test (`src/components/ui/__tests__/Button.test.tsx`) must pass.
  - These confirm the Jest and React Testing Library setup.
- **Integration Tests:**
  - Not applicable for this setup story. Mocking infrastructure will enable future integration tests.
- **Manual/CLI Verification:**
  - Run `npm test` (or equivalent script): Verify Jest runs, and both example tests pass.
  - Run `npm run test:cov` (or equivalent script): Verify coverage report is generated in `coverage/`.
- **Automated Verification:**
  - The primary output *is* the setup for automated tests.

## DoD Checklist (Story Specific Points)

- [x] **Requirements & ACs:** All criteria in DoD section 3.1 met.
- [x] **Design & Implementation:** All criteria in DoD section 3.2 met.
- [x] **Testing & Verification:** All criteria in DoD section 3.3 met.
- [x] **Documentation & Handover:** All criteria in DoD section 3.4 met.
- [x] **Story Management:** All criteria in DoD section 3.5 met.
- _(Note: This is a reminder; detailed checks are in `docs/definition-of-done.md`)_

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Gemini 2.5 Pro (via Cursor)`
- **Completion Notes:** 
  - All tasks completed as per story requirements.
  - Installed `identity-obj-proxy` for CSS mocking.
  - Jest configuration (`jest.config.cjs`) was updated to include CSS module mapping. The existing test setup file `src/test-setup.ts` was retained as it served the purpose of `jest.setup.js` and already included `@testing-library/jest-dom`.
  - `tsconfig.json` was updated to include "jest" in types and set `jsx: "react-jsx"`.
  - Existing test scripts in `package.json` were retained as they were more specific (included `--config`) but fulfilled the requirements.
  - `coverage/` was already present in `.gitignore`.
  - Mock infrastructure created in `src/__mocks__/lib/` for Supabase, Resend, Gemini (placeholder), and Stripe (placeholder). Paths for Gemini and Stripe clients were not found, so placeholder mocks were created at assumed locations.
  - Example unit test (`tests/unit/example.test.ts`) and component test (`src/components/ui/__tests__/Button.test.tsx`) were created and successfully pass.
  - All existing tests in the project also passed after these changes, though some pre-existing console warnings/errors were observed from other tests.
  - `npm test` and `npm run test:coverage` (correct script name) run successfully.
  - DoD criteria were met by following the story's technical guidance, ensuring configurations are correct, creating specified files, and verifying through test execution.
- **Change Log:** 
  - Initial Draft 
  - Updated dependencies, Jest config, tsconfig.
  - Created mock files and example tests.