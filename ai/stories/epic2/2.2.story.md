# Story 2.2: Gemini API Integration for OCR Processing

**Status:** Review

**DoD Reference:** All aspects of this story must adhere to the standards outlined in `docs/definition-of-done.md`.

## Goal & Context

**User Story:** As a Developer, I want to integrate the Gemini API for OCR processing, so that text can be extracted from the uploaded test documents.

**Context:** This story follows the successful implementation of file uploads (Story 2.1). Once a test document (PDF or image) is uploaded and temporarily stored, this story focuses on creating the backend mechanism to send that document to the Google Gemini API (specifically, a model with Vision capabilities) to perform Optical Character Recognition (OCR) and retrieve the raw textual content. The highly structured parsing of this text, guided by the user-provided prompt, will be handled in Story 2.4.

## Detailed Requirements

- Securely configure and manage the Google Gemini API key.
- Develop a backend service or function that takes a temporarily stored file (path or buffer from Story 2.1) as input.
- This function will send the file content to the appropriate Gemini Vision API endpoint for text extraction.
- The system must handle API responses from Gemini, including successful responses containing the extracted text and various error conditions (e.g., API errors, unreadable document by Gemini, rate limits).
- The raw extracted text from a successful OCR process should be stored temporarily or passed on, ready for the parsing stage in Story 2.4. For files that fail OCR, an appropriate error status should be recorded.

## Acceptance Criteria (ACs)

- AC1: Google Gemini API key is securely stored and accessible by the backend service (e.g., via environment variables).
- AC2: A backend function is created that accepts a file identifier (e.g., temporary path or ID of an uploaded file from Story 2.1).
- AC3: The function successfully sends the file content (image or PDF) to the Gemini Vision API for OCR.
- AC4: The function correctly retrieves the raw extracted text from a successful Gemini API response.
- AC5: The function handles and logs common Gemini API errors gracefully (e.g., authentication failure, processing error, invalid file type for OCR).
- AC6: The raw extracted text (on success) or an error status (on failure) is associated with the original uploaded file and made available for subsequent processing steps (e.g., by updating a status in a database record related to the uploaded file or passing it to a next queue/job).

## Technical Implementation Context

**Guidance:** The primary goal is to get raw text from Gemini. The detailed parsing and structuring of this text using the user-provided prompt will be handled in Story 2.4.

- **Relevant Files:**

  - Files to Create:
    - `src/services/gemini-ocr-service.ts`: Module responsible for all interactions with the Gemini API for OCR.
    - `src/lib/config/gemini-config.ts`: For managing Gemini API key and related configurations.
    - Potentially a new table or updates to an existing table (e.g., `uploaded_documents`) to store OCR status and raw text output or error.
  - Files to Modify:
    - The backend process that handles files after upload (from Story 2.1) will need to call the new `gemini-ocr-service.ts`.
    - `src/types/ocr-types.ts` (or similar) for defining interfaces related to OCR results (raw text, error states).

- **Key Technologies:**

  - Node.js (for the backend service)
  - TypeScript
  - Google Gemini SDK (e.g., `@google/generative-ai`). Research the appropriate SDK and API for multimodal (image/PDF text extraction) capabilities.
  - Axios or a similar HTTP client if direct API calls are preferred over an SDK, though SDK is recommended.

- **API Interactions / SDK Usage:**

  - Use the Gemini API, specifically a model that supports vision and OCR from PDF/image inputs (e.g., Gemini Pro Vision or a newer equivalent if available).
  - The user-provided system prompt will be integrated in Story 2.4. For this story, the focus is on basic text extraction. However, the request to Gemini should be structured to expect text output.
  - Authentication will be handled via the API key passed in requests as per Gemini SDK/API documentation.
  - Error handling: Implement retries for transient errors if appropriate, and log specific Gemini error codes/messages.

- \*\*Data Structures (e.g., in `src/types/ocr-types.ts`):

  ```typescript
  export interface OcrResult {
    fileId: string; // Relates back to the uploaded file
    status: 'success' | 'error_ocr_processing' | 'error_api_unavailable';
    rawText?: string;
    ocrErrorMessage?: string;
    geminiModelUsed?: string;
  }
  ```

- **Environment Variables:**

  - `GEMINI_API_KEY`: The API key for accessing Google Gemini services.

- **Coding Standards Notes:**
  - All API interactions must be asynchronous (`async/await`).
  - Securely handle the API key; do not expose it in client-side code or commit to version control directly.
  - Implement comprehensive logging for API requests, responses, and errors.

## Tasks / Subtasks

- [x] Research and select the appropriate Google Gemini SDK/API version for OCR from PDF and image files.
- [x] Set up `GEMINI_API_KEY` in the project's environment variable management system (e.g., `.env.local`, Vercel environment variables).
- [x] Create `src/lib/config/gemini-config.ts` to securely load and provide the API key.
- [x] Implement the core function in `src/services/gemini-ocr-service.ts`:
  - [x] Takes file path/buffer/identifier as input.
  - [x] Initializes the Gemini client/SDK with the API key.
  - [x] Prepares the file content for the API request (e.g., base64 encoding for images if required by the SDK/API).
  - [x] Makes the API call to Gemini Vision model for text extraction.
  - [x] Handles successful response: extracts raw text.
  - [x] Handles error responses: captures error details.
  - [x] Returns an `OcrResult` object.
- [x] Define the `OcrResult` interface in `src/types/ocr-types.ts`.
- [x] Integrate the `gemini-ocr-service.ts` into the post-upload processing workflow:
  - [x] After a file is successfully uploaded (from Story 2.1), trigger the OCR service.
  - [x] Store/update the `OcrResult` (e.g., in a database table like `knowledge_test_uploads` with fields for `ocr_status`, `raw_text`, `ocr_error_message`).
- [x] Implement basic logging for OCR attempts, successes, and failures.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. **All testing must satisfy the criteria in `docs/definition-of-done.md` (section 3.3).**

- **Unit Tests:**
  - Test `gemini-config.ts` to ensure API key is loaded correctly (mock environment variables).
  - Test `gemini-ocr-service.ts` (critical):
    - Mock the Gemini SDK/API client.
    - Test successful OCR: verify correct parameters sent to Gemini and raw text is returned.
    - Test various Gemini API error scenarios (mocked responses: API key error, file unreadable, rate limit, etc.) and ensure they are handled and reported correctly in `OcrResult`.
    - Test handling of different file input types if preprocessing logic exists (e.g., image vs. PDF specific handling before API call).
- **Integration Tests:**
  - (Optional, if feasible and provides value beyond unit tests) Create a limited integration test that makes a real call to the Gemini API with a small, non-sensitive test image/PDF if a sandboxed/dev Gemini environment is available. This should be used sparingly due to potential costs and flakiness. **Focus heavily on robust mocking for unit tests.**
- **Manual Verification (Developer/QA):**
  - During development, manually trigger the OCR service with sample PDF and image files (using a test script or endpoint if necessary).
  - Check logs for correct API interaction and error reporting.
  - Verify that the raw extracted text (or error status) is correctly stored or passed on.

## DoD Checklist (Story Specific Points)

- [x] **Requirements & ACs:** All criteria in DoD section 3.1 met.
- [x] **Design & Implementation:** All criteria in DoD section 3.2 met.
- [x] **Testing & Verification:** All criteria in DoD section 3.3 met.
- [x] **Documentation & Handover:** All criteria in DoD section 3.4 met.
- [x] **Story Management:** All criteria in DoD section 3.5 met.
- _(Note: This is a reminder; detailed checks are in `docs/definition-of-done.md`)_

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Claude 3.7 Sonnet`
- **Completion Notes:** Successfully implemented Gemini API integration for OCR processing of uploaded test documents. Created a secure configuration for the API key, a robust OCR service with error handling and retries, and integrated it into the existing upload workflow. The implementation extracts text from PDF and image files using the Gemini Pro Vision model and captures the results for future processing. Full test coverage ensures the service handles various scenarios properly.
- **Change Log:** {Track changes _within this specific story file_ if iterations occur}
  - Initial Draft
  - Updated status to "In-Progress"
  - Marked all tasks as completed and updated status to "Review"
