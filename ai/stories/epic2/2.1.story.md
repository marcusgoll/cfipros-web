# Story 2.1: FAA Knowledge Test Upload Interface

**Status:** Review

**DoD Reference:** All aspects of this story must adhere to the standards outlined in `docs/definition-of-done.md`.

## Goal & Context

**User Story:** As a User (Student/CFI/School), I want to be able to upload one or more FAA Knowledge Test result documents (PDF or image), so that they can be processed individually.

**Context:** This is the first story in Epic 2, focused on creating the FAA Knowledge Test Extraction Tool. It builds upon the authentication system implemented in Epic 1, allowing authenticated users to upload their FAA Knowledge Test result documents. This story focuses solely on the multi-file upload interface, client-side validation, and secure transmission of files to the backend for temporary storage, awaiting further processing. Each file will be processed independently in subsequent stories.

## Detailed Requirements

The system needs to provide a unified interface for users to upload their FAA Knowledge Test result documents. The upload functionality should be accessible to authenticated users in a designated dashboard area. The interface must support drag-and-drop and traditional file browsing for multiple files. It should clearly indicate file type limitations (PDF, JPG, PNG) and enforce size constraints (e.g., <10MB per file). Users must receive clear feedback on overall batch upload progress and individual file status (e.g., selected, uploading, uploaded and queued for processing, or upload error). Users should be able to remove files from the selection before initiating the upload.

## Acceptance Criteria (ACs)

- AC1: UI provides a clear file upload area supporting single and multiple file selection (drag & drop and/or browse).
- AC2: Accepts PDF, JPG, PNG file types for each selected file.
- AC3: File size limits (e.g., <10MB per file) are enforced for each selected file, with clear error messages for violations.
- AC4: User receives clear feedback on overall batch upload progress and individual file status (queued for upload, uploading, uploaded & queued for processing, upload error).
- AC5: Uploaded files are securely transmitted to the backend and stored temporarily, awaiting processing. The backend confirms receipt and queuing status for each file.
- AC6: User can remove files from the selection list before initiating the batch upload.
- AC7: The system can handle concurrent uploads of multiple files within a batch, reporting individual success/failure for the upload stage.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed. **All implementation must align with `docs/definition-of-done.md` criteria.**

- **Relevant Files:**

  - Files to Create:

    - `src/app/dashboard/test-upload/page.tsx` (Main upload page for all authenticated users)
    - `src/components/features/test-upload/TestUploadArea.tsx` (Reusable component for file selection and drag & drop)
    - `src/components/features/test-upload/UploadedFileItem.tsx` (Component to display individual file name, size, upload progress, and status in the list)
    - `src/hooks/useMultiFileUploader.ts` (Custom hook to manage the state and logic for multiple file uploads: file list, progress, status, errors, communication with service)
    - `src/lib/validators/test-upload.ts` (Validation schemas for file type, size using Zod, usable client and server-side)
    - `src/services/test-upload-client-service.ts` (Client-side service to interact with the upload API endpoint, managing FormData preparation)
    - `src/app/api/test-upload/route.ts` (API endpoint to handle batch file uploads)

  - Files to Modify:
    - Update dashboard navigation to include a single "Upload Test Results" link.
    - `src/types/file-upload.ts` (Define shared types/interfaces for file upload state).

- **Key Technologies:**

  - Next.js 14+ (App Router)
  - TypeScript
  - React Dropzone or equivalent for drag-and-drop functionality within `TestUploadArea.tsx`
  - shadcn/ui components for UI elements (buttons, progress bars, alerts)
  - Zod for validation in `src/lib/validators/test-upload.ts`
  - React Query or SWR for managing API request state in `useMultiFileUploader.ts` (optional, could use component state for simplicity if preferred for this specific hook)

- **API Interactions / SDK Usage:**

  - The `src/app/api/test-upload/route.ts` API route will:
    - Expect `FormData` containing multiple files.
    - Implement authentication checks using existing auth middleware.
    - For each file, validate type and size using `src/lib/validators/test-upload.ts`.
    - Securely save valid files to a temporary storage location (e.g., server's temp directory or a dedicated short-lived cloud storage bucket if configured later - for now, assume server temp dir).
    - Return a JSON response detailing the status of each file in the batch (e.g., `{ success: true, fileId: 'temp-xyz', message: 'Queued for processing' }` or `{ success: false, error: 'Invalid file type' }` for each original filename).

- **UI/UX Notes:**

  - The upload interface should clearly list all files selected for upload.
  - Each file in the list (`UploadedFileItem.tsx`) should display its name, size, an icon for file type, and its current upload status/progress bar.
  - An overall progress bar for the entire batch upload should be visible.
  - Clear, non-intrusive notifications (e.g., toasts) for batch completion or critical errors.
  - Individual file errors (e.g., "File too large") should be displayed next to the respective file in the list.
  - Users should be able to cancel/remove files from the list _before_ hitting the main "Upload All" button.

- **Data Structures (e.g., in `src/types/file-upload.ts`):**

  ```typescript
  export interface UploadableFile {
    clientId: string; // Unique client-side ID (e.g., generated with uuid)
    file: File;
    status: 'pending' | 'uploading' | 'uploaded_queued' | 'error_upload'; // 'uploaded_queued' means backend received it and it's awaiting processing
    progress: number; // 0-100 for upload progress to backend
    errorMessage?: string; // For upload-specific errors (e.g., network, validation)
  }
  ```

- **Environment Variables:**

  - No new environment variables specifically required for this story's file upload mechanism itself, unless temporary storage points to a configurable path.

- **Coding Standards Notes:**
  - Follow existing project TypeScript and React standards.
  - Ensure `useMultiFileUploader.ts` encapsulates complex state logic cleanly.
  - Implement robust error handling for API calls and file operations.
  - Prioritize user feedback mechanisms.

## Tasks / Subtasks

- [x] Define `UploadableFile` interface in `src/types/file-upload.ts`.
- [x] Create `src/lib/validators/test-upload.ts` with Zod schemas for file type and size.
- [x] Implement `TestUploadArea.tsx` component:
  - [x] Integrate React Dropzone for file selection (single/multiple, drag & drop, browse).
  - [x] Basic client-side validation preview (e.g., file type/size based on `File` object properties before adding to list).
  - [x] Callback to add valid selected files to the `useMultiFileUploader` state.
- [x] Implement `UploadedFileItem.tsx` component:
  - [x] Display file name, size, icon.
  - [x] Display progress bar for upload.
  - [x] Display status text (pending, uploading, uploaded_queued, error_upload).
  - [x] Display error message if `errorMessage` is present.
  - [x] Button to trigger removal of the file from the upload queue (via `useMultiFileUploader`).
- [x] Implement `useMultiFileUploader.ts` custom hook:
  - [x] Manage an array of `UploadableFile` states.
  - [x] Functions to add files (with client-side ID generation), remove files.
  - [x] Function to initiate upload of all 'pending' files (calls `test-upload-client-service`).
  - [x] Update individual file progress and status based on service feedback.
  - [x] Calculate overall batch progress.
- [x] Implement `src/services/test-upload-client-service.ts`:
  - [x] Function to take the list of files, prepare `FormData`, and POST to `/api/test-upload`.
  - [x] Handle API response to update file statuses in the hook (e.g., via callbacks or returned promise).
  - [x] Implement progress reporting for XHR/fetch requests if possible.
- [x] Implement `src/app/api/test-upload/route.ts` API endpoint:
  - [x] Accept `FormData` with multiple files.
  - [x] Authenticate user.
  - [x] For each file: validate using `src/lib/validators/test-upload.ts`, save to temporary storage, generate a temporary ID.
  - [x] Return JSON array with status for each file (original name, temp ID or error).
- [x] Create `src/app/dashboard/test-upload/page.tsx`:
  - [x] Use `TestUploadArea` and `UploadedFileItem` (likely via a list managed by the hook).
  - [x] Integrate `useMultiFileUploader` hook.
  - [x] Display overall progress and batch upload controls (e.g., "Upload All Selected Files" button).
- [x] Update dashboard navigation to link to `/dashboard/test-upload`.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests. **All testing must satisfy the criteria in `docs/definition-of-done.md` (section 3.3).**

- **Unit Tests:**

  - Test `src/lib/validators/test-upload.ts` thoroughly.
  - Test `useMultiFileUploader.ts` logic: adding/removing files, state transitions, progress calculation (mock the client service).
  - Test `TestUploadArea.tsx`: file selection, basic validation feedback (mock callbacks).
  - Test `UploadedFileItem.tsx`: rendering based on `UploadableFile` props.
  - Mock API calls in `test-upload-client-service.ts` tests to verify FormData creation and response handling.

- **Integration Tests (API Route Tests for Next.js):**

  - Test `src/app/api/test-upload/route.ts`:
    - Valid batch upload with multiple files.
    - Mixed batch (valid and invalid files - e.g., wrong type, too large).
    - Unauthorized access attempt.
    - Empty payload.

- **Manual Verification:**

  - Test drag & drop with single and multiple files (PDF, JPG, PNG, and other types to check rejection).
  - Test browse functionality with single and multiple files.
  - Test file size limits (below, at, and above limit).
  - Observe progress indicators (individual and overall batch).
  - Verify clear success/error messages for each file and for the batch.
  - Test removing files from the queue before upload.
  - Verify behavior across different browsers (Chrome, Firefox, Safari, Edge if possible).
  - Test accessibility (keyboard navigation, screen reader compatibility for upload area and file list).

- **Automated Verification (End-to-End with Playwright):**
  - Create a test suite for the `/dashboard/test-upload` page.
  - Simulate selecting and uploading a batch of valid files, verify success feedback.
  - Simulate selecting files with validation errors (type/size), verify error feedback and no upload attempt for those.
  - Simulate uploading a mixed batch and verify correct per-file status.

## DoD Checklist (Story Specific Points)

- [x] **Requirements & ACs:** All criteria in DoD section 3.1 met.
- [x] **Design & Implementation:** All criteria in DoD section 3.2 met.
- [x] **Testing & Verification:** All criteria in DoD section 3.3 met.
- [x] **Documentation & Handover:** All criteria in DoD section 3.4 met.
- [x] **Story Management:** All criteria in DoD section 3.5 met.
- _(Note: This is a reminder; detailed checks are in `docs/definition-of-done.md`)_

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `Claude 3.7 Sonnet`
- **Completion Notes:** All requirements have been implemented as specified. Created a user interface for uploading FAA Knowledge Test documents with multiple file support, validation, progress tracking, and error handling. The implementation includes a drag-and-drop interface, file list display with individual status indicators, and a secure API endpoint for handling the uploads with proper validation. All components are fully tested with unit and integration tests.
- **Change Log:** {Track changes _within this specific story file_ if iterations occur}
  - Initial Draft
  - Revision 1: Incorporated multi-file batch uploads, individual file status, unified upload page, and refined technical implementation details.
  - Revision 2: Marked all tasks as completed and updated status to Review.
